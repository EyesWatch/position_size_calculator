<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Position Size Calculator (Offline)</title>
  <style>
    body{font-family:sans-serif;background:#0f1115;color:#eaeaea;margin:0;padding:20px}
    .card{background:#161a22;border:1px solid #252a34;border-radius:12px;padding:16px;max-width:900px;margin:auto}
    label{display:block;margin-top:10px}
    input,select,button{width:100%;padding:8px;margin-top:4px;background:#0f1115;color:#eaeaea;border:1px solid #2c3340;border-radius:6px}
    button{background:#2871ff;cursor:pointer;margin-top:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .result{margin-top:14px;padding:10px;border:1px dashed #444;border-radius:6px}
    small{color:#9aa2b2}
  </style>
</head>
<body>
<div class="card">
  <h2>Position Size Calculator — Offline</h2>
  <div class="grid">
    <div><label>Solde du compte<input id="balance" type="number" value="10000"></label></div>
    <div><label>Risque %<input id="riskPct" type="number" value="1"></label></div>
    <div><label>Entrée<input id="entry" type="number" step="0.0001"></label></div>
    <div><label>Stop-Loss (prix)<input id="sl" type="number" step="0.0001"></label></div>
    <div><label>Take-Profit (optionnel)<input id="tp" type="number" step="0.0001"></label></div>
    <div>
      <label>Valeur pip/tick par 1 lot<input id="pipValue" type="number" value="10"></label>
      <small>Ex: EURUSD ≈ 10 $/pip/lot. Adaptez selon votre broker.</small>
    </div>
    <div>
      <label>Buffer spread/slippage (pips/ticks)<input id="buffer" type="number" step="0.01" value="0"></label>
      <small>Ajouté à la distance du SL (sécurité).</small>
    </div>
    <div>
      <label>Commission par lot (round‑trip)<input id="commission" type="number" step="0.01" value="3"></label>
      <small>Par défaut FTMO Forex ≈ 3 $ par lot (aller+retour). Modifiez si besoin.</small>
    </div>
    <div>
      <label>Incrément de lot
        <select id="lotStep">
          <option value="1">1.00</option>
          <option value="0.1">0.10</option>
          <option value="0.01" selected>0.01</option>
          <option value="0.001">0.001</option>
        </select>
      </label>
    </div>
  </div>

  <button id="calcBtn">Calculer</button>
  <div id="out" class="result"></div>
</div>

<script>
function roundStep(v,step){return Math.floor(v/step)*step;}

function compute(){
  const get = id => document.getElementById(id).value;
  const bal = parseFloat(get('balance'));
  const riskPct = parseFloat(get('riskPct'));
  const entry = parseFloat(get('entry'));
  const sl = parseFloat(get('sl'));
  const tpVal = get('tp');
  const tp = tpVal==='' ? null : parseFloat(tpVal);
  const pipValue = parseFloat(get('pipValue'));
  const buffer = parseFloat(get('buffer')) || 0;
  const commission = parseFloat(get('commission')) || 0; // $ per lot round-trip
  const lotStep = parseFloat(get('lotStep'));
  const out = document.getElementById('out');

  if(![bal,riskPct,entry,sl,pipValue].every(isFinite)){
    out.innerHTML="Veuillez remplir solde, risque %, entrée, SL et valeur pip/tick.";
    return;
  }
  const riskAmt = bal * (riskPct/100);
  const distPrice = Math.abs(entry - sl);
  if(distPrice === 0){ out.innerHTML="Distance entrée/SL invalide."; return; }

  // Money per lot for price distance + buffer
  const distMoneyPerLot = distPrice * pipValue;
  const bufferMoneyPerLot = (buffer || 0) * pipValue;

  // Total risk per lot includes buffer + commission
  const riskPerLot = distMoneyPerLot + bufferMoneyPerLot + commission;

  const rawLot = riskAmt / riskPerLot;
  const lot = Math.max(roundStep(rawLot, lotStep), lotStep);

  const impliedRisk = lot * riskPerLot;
  const reward = (tp!==null && isFinite(tp)) ? lot * Math.abs(tp - entry) * pipValue : null;
  const rr = reward ? (reward / (lot * (distMoneyPerLot + bufferMoneyPerLot))).toFixed(2) : "-"; // R:R sans commission

  out.innerHTML = [
    "Lot: <b>"+lot.toFixed(3)+"</b>",
    "Risque ≈ <b>"+impliedRisk.toFixed(2)+"</b> (incl. buffer & commission)",
    "Détail par lot: distance "+distMoneyPerLot.toFixed(2)+" + buffer "+bufferMoneyPerLot.toFixed(2)+" + commission "+commission.toFixed(2),
    "R:R (si TP) = <b>"+rr+"</b>"
  ].join("<br>");
}

document.getElementById('calcBtn').addEventListener('click', compute);
</script>
</body>
</html>